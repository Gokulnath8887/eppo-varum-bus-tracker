rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Current session - readable by all, writable only by authenticated drivers
    match /app/currentSession {
      allow read: if true;
      allow write: if request.auth != null && request.auth.token.role == 'driver';
    }
    
    // Sessions - readable by all, writable only by authenticated drivers
    match /sessions/{rideId} {
      allow read: if true;
      allow create: if request.auth != null && request.auth.token.role == 'driver';
      allow update: if request.auth != null && request.auth.token.role == 'driver';
      
      // Location history subcollection
      match /locations/{locationId} {
        allow read: if true;
        allow create: if request.auth != null && request.auth.token.role == 'driver';
      }
    }
    
    // FCM tokens - users can only write their own tokens
    match /fcmTokens/{tokenId} {
      allow read: if false;
      allow write: if true; // Allow anyone to register their token
    }
    
    // Drivers collection - admin only (for setup)
    match /drivers/{driverId} {
      allow read: if request.auth != null;
      allow write: if false; // Use Firebase Console or Admin SDK
    }
  }
}
